<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
 
  <script type="module">
    import  {instance } from "./viz.js";

    // Viz.instance().then(viz => {
    //   document.body.appendChild(viz.renderSVGElement("digraph { a -> b }"))
    // });
    // 假设你通过 npm 安装并打包了，或者直接引用 CDN
    // 如果是本地文件: import { instance } from "./path/to/viz-js/index.js";
    // import { instance } from "https://cdn.jsdelivr.net/npm/@viz-js/viz@3.2.4/+esm";

    async function renderAllGraphs() {
      try {
        // 1. 初始化 Viz 实例 (加载 WASM)
        const viz = await instance();

        // 2. 选择所有需要渲染的代码块
        // markdown-it 默认生成 <pre><code class="language-dot">...</code></pre>
        const codes = document.querySelectorAll('pre code.language-dot, pre code.language-graphviz');

        // 3. 遍历并处理
        codes.forEach(codeElement => {
          const preElement = codeElement.parentElement; // 获取外层的 <pre>
          const sourceCode = codeElement.textContent;   // 获取 DOT 源码

          try {
            // 4. 渲染 SVG DOM 元素
            const svgElement = viz.renderSVGElement(sourceCode);
            
            // 5. 原位替换：用生成的 SVG 替换掉原本的 <pre> 标签
            // 这样图表就会出现在原本代码所在的位置
            preElement.replaceWith(svgElement);
            
          } catch (renderError) {
            console.error("Graphviz 渲染失败:", renderError);
            
            // 可选：在页面上显示错误信息，而不是让它崩溃
            const errorDiv = document.createElement('div');
            errorDiv.className = 'viz-error';
            errorDiv.innerText = `渲染错误: ${renderError.message}`;
            preElement.replaceWith(errorDiv);
          }
        });

      } catch (err) {
        console.error("Viz 实例初始化失败:", err);
      }
    }

    // 执行渲染
    renderAllGraphs();
  </script>
</body>
</html>