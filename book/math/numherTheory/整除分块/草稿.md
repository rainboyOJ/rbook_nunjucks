这是一个关于 **“整除分块” (Harmonic Lemma / Number Theory Blockade)** 的详细教程。

在数论和竞赛编程（Competitive Programming）中，整除分块是一个非常基础且极其重要的技巧。它主要用于在 $O(\sqrt{n})$ 的时间复杂度内计算含有 $\lfloor \frac{n}{i} \rfloor$ 的和式。

-----

### 1\. 问题引入

假设我们需要计算下面这个式子的值：
$$\text{Ans} = \sum_{i=1}^{n} \lfloor \frac{n}{i} \rfloor$$

如果 $n$ 的范围较小（例如 $n \le 10^5$），我们可以直接 $O(n)$ 暴力计算。
但在很多题目中，$n$ 可能高达 $10^9$ 甚至 $10^{14}$（配合杜教筛等），此时 $O(n)$ 必然超时。我们需要一种 $O(\sqrt{n})$ 的方法，这就是**整除分块**。

-----

### 2\. 核心直觉与观察

让我们以 $n=10$ 为例，列出所有的 $\lfloor \frac{10}{i} \rfloor$ 的值：

| $i$ | $\lfloor \frac{10}{i} \rfloor$ |
| :---: | :---: |
| **1** | **10** |
| **2** | **5** |
| **3** | **3** |
| **4** | **2** |
| **5** | **2** |
| **6** | **1** |
| **7** | **1** |
| **8** | **1** |
| **9** | **1** |
| **10** | **1** |

**观察：**
你会发现 $\lfloor \frac{n}{i} \rfloor$ 的值呈现出 **“块状分布”**。
例如，当 $i \in [4, 5]$ 时，值都是 2；当 $i \in [6, 10]$ 时，值都是 1。

**结论：**
虽然 $i$ 在变化，但 $\lfloor \frac{n}{i} \rfloor$ 的值在一段连续区间内是**不变**的。如果我们可以直接跳过这整个区间，一次性把这一段的和算出来，就能大大加速。

-----

### 3\. 数学推导 (确定块的右端点)

假设当前区间的左端点是 $l$，我们需要找到一个最大的右端点 $r$，使得在区间 $[l, r]$ 内：
$$\lfloor \frac{n}{i} \rfloor = \text{常数 } k \quad (\text{其中 } k = \lfloor \frac{n}{l} \rfloor)$$

我们需要找到满足 $\lfloor \frac{n}{r} \rfloor = \lfloor \frac{n}{l} \rfloor$ 的最大 $r$。
根据向下取整的性质，我们有结论公式：

$$r = \lfloor \frac{n}{\lfloor \frac{n}{l} \rfloor} \rfloor$$

\<details\>
\<summary\>\<strong\>👉 点击查看证明 (为什么是这个公式?)\</strong\>\</summary\>

设 $k = \lfloor \frac{n}{l} \rfloor$。
根据整除定义，我们要求满足 $\lfloor \frac{n}{i} \rfloor = k$ 的最大 $i$。
由不等式性质：
$$\lfloor \frac{n}{i} \rfloor \ge k \implies \frac{n}{i} \ge k \implies i \le \frac{n}{k}$$
因为 $i$ 必须是整数，所以 $i$ 的最大值（即 $r$）为：
$$r = \lfloor \frac{n}{k} \rfloor = \lfloor \frac{n}{\lfloor \frac{n}{l} \rfloor} \rfloor$$

\</details\>

-----

### 4\. 复杂度证明

为什么这样做快？
对于 $n$，$\lfloor \frac{n}{i} \rfloor$ 的取值只有 $2\sqrt{n}$ 种可能性。

1.  **当 $i \le \sqrt{n}$ 时：** $i$ 只有 $\sqrt{n}$ 个值，所以商最多有 $\sqrt{n}$ 种。
2.  **当 $i > \sqrt{n}$ 时：** $\lfloor \frac{n}{i} \rfloor < \sqrt{n}$。商的值域在 $[0, \sqrt{n})$ 之间，最多也只有 $\sqrt{n}$ 种。

**总复杂度：** $O(\sqrt{n})$。

-----

### 5\. 代码模板 (C++)

这是整除分块的标准写法。请务必理解 `l` 和 `r` 的迭代逻辑。

```cpp
long long solve(long long n) {
    long long ans = 0;
    // l 是当前块的左端点，r 是当前块的右端点
    for (long long l = 1, r; l <= n; l = r + 1) {
        // 计算当前块的值 k
        long long k = n / l;
        
        // 计算当前块的右端点 r
        // 如果 k=0 (也就是 i > n 的情况，虽然循环条件限制了 l<=n，但在某些多变量分块中要注意防除0)
        if (k == 0) r = n; 
        else r = min(n, n / k); // 取 min 是为了防止 r 超过 n (在多变量分块中很重要)
        
        // 计算这一块的贡献
        // 这一块的长度是 (r - l + 1)，每一项的值都是 k
        ans += (r - l + 1) * k;
    }
    return ans;
}
```

-----

### 6\. 进阶应用：多变量分块

在莫比乌斯反演或求 GCD 和这类题目中，我们经常遇到这种形式：
$$\sum_{i=1}^{\min(n, m)} \lfloor \frac{n}{i} \rfloor \lfloor \frac{m}{i} \rfloor$$

此时不仅 $n$ 分块，$m$ 也要分块。我们需要让 $\lfloor \frac{n}{i} \rfloor$ 和 $\lfloor \frac{m}{i} \rfloor$ **同时**保持不变。
**策略：** 取两者的右端点中较小的那个作为共同的右端点。

**代码片段：**

```cpp
long long limit = min(n, m);
for (long long l = 1, r; l <= limit; l = r + 1) {
    // 每次跳跃，取由 n 决定的右端点和由 m 决定的右端点中的较小值
    r = min(limit, min(n / (n / l), m / (m / l)));
    
    // 计算贡献
    ans += (n / l) * (m / l) * (r - l + 1);
}
```

-----

### 7\. 实战练习建议

为了巩固这个知识点，建议你按照以下顺序练习：

1.  **洛谷 P2261 [CQOI2007] 余数求和**
      * **核心：** 利用 $k \bmod i = k - i \times \lfloor \frac{k}{i} \rfloor$，将问题转化为求 $\sum \lfloor \frac{k}{i} \rfloor$。这是最纯粹的整除分块模板题。
2.  **UVa 11526 - H(n)**
      * 直接求 $\sum \lfloor \frac{n}{i} \rfloor$，用来测试模板正确性。
3.  **洛谷 P2260 [清华集训2012] 模积和**
      * 涉及多变量分块和取模处理，难度适中。

### 总结

  * **适用场景：** 求形如 $\sum \lfloor \frac{n}{i} \rfloor$ 的和式。
  * **公式：** 右端点 $r = n / (n / l)$。
  * **复杂度：** $O(\sqrt{n})$。
  * **陷阱：** 记得开 `long long`；在多变量分块时注意 `r` 取 `min`。

你想先试着写一下 **洛谷 P2261 余数求和** 这道题吗？我可以为你提供这道题的推导思路。