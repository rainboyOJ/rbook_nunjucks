## 技术栈（最小化依赖）

- **markdownit**: Markdown解析（核心功能）
- **nunjucks**: 模板引擎（必需）
- **js-yaml**: YAML配置解析（简单直接）

> 注：移除commander，使用原生process.argv处理命令行

## 项目结构（简化版）

```
├── bin/rbook.js          # 单一入口，build/serve命令
├── src/
│   ├── builder.js        # 核心构建逻辑
│   ├── parser.js         # Markdown+FrontMatter解析
│   └── server.js         # 开发服务器
├── book/                 # 书籍内容
│   ├── index.md          # 首页内容
│   ├── about.md          # 关于页面
│   └── {{chapter}}/index.md
├── theme/                # 主题模板
│   ├── layout.njk        # 基础布局
│   ├── index.njk         # 首页模板
│   ├── page.njk          # 单页模板（关于等）
│   ├── chapter.njk       # 章节模板
│   ├── partials/
│   │   ├── header.njk    # 页头
│   │   ├── footer.njk    # 页脚
│   │   ├── menu.njk      # 导航菜单
│   │   └── toc.njk       # 目录
│   └── assets/
│       ├── css/style.css
│       └── js/main.js
├── book.yaml            # 简化配置文件
└── package.json
```

> 核心原则：文件最少化，每个文件职责单一

book.yaml（极简配置）

```yaml
title: 我的书
author: 张三
description: 这是一本关于算法的书

chapters:
  - title: 第一章
    path: chapter1
  - title: 第二章
    path: chapter2
    sections:
      - title: 第一节
        path: chapter2-1
      - title: 第二节  
        path: chapter2-2
```

> 约定优于配置：每个章节必须是index.md文件

## 三秒规则设计

整个处理流程必须在3秒内理解：

**输入**：Markdown文件 + 全局数据 → **输出**：HTML页面

```
Markdown文件 → [读取+解析] → [模板渲染] → [HTML输出]
     ↓
FrontMatter数据 → 合并到全局变量
```

> 核心：一个函数完成一个步骤，流程线性无分支

## 核心设计（函数>类）

### 主流程（4个函数）

```javascript
// 1. 读取配置
const config = loadConfig('book.yaml')

// 2. 处理单个文件（支持不同模板）
const processFile = (filePath, templateType = 'chapter') => {
  const content = fs.readFileSync(filePath, 'utf8')
  const {data, body} = parseFrontMatter(content)  // 解析FrontMatter
  
  // 根据页面类型选择模板
  const templateMap = {
    'index': 'index.njk',
    'page': 'page.njk', 
    'chapter': 'chapter.njk'
  }
  
  const rendered = renderTemplate(body, {...config, ...data})  // 模板渲染
  const html = markdownToHtml(rendered)  // Markdown转HTML
  
  // 构建导航数据
  const nav = buildNavigation(config)
  
  // 渲染最终页面
  return renderTemplate(templateMap[templateType], {
    site: config,
    page: {
      title: data.title || '无标题',
      content: html,
      type: templateType,
      path: filePath
    },
    nav: nav
  })
}

// 构建导航数据（简单直接）
const buildNavigation = (config) => {
  const nav = []
  
  // 首页
  nav.push({title: '首页', path: '/', type: 'index'})
  
  // 关于页面（如果存在）
  if (fs.existsSync('book/about.md')) {
    nav.push({title: '关于', path: '/about.html', type: 'page'})
  }
  
  // 章节导航
  config.chapters.forEach(chapter => {
    nav.push({
      title: chapter.title,
      path: `/${chapter.path}/`,
      type: 'chapter'
    })
  })
  
  return nav
}

// 3. 构建所有文件（支持多页面类型）
const build = () => {
  // 构建首页
  const indexHtml = processFile('book/index.md', 'index')
  fs.writeFileSync('dist/index.html', indexHtml)
  
  // 构建关于页面（如果存在）
  if (fs.existsSync('book/about.md')) {
    const aboutHtml = processFile('book/about.md', 'page')
    fs.writeFileSync('dist/about.html', aboutHtml)
  }
  
  // 构建章节页面
  config.chapters.forEach(chapter => {
    const html = processFile(`book/${chapter.path}/index.md`, 'chapter')
    fs.writeFileSync(`dist/${chapter.path}/index.html`, html)
  })
}
```

### 设计原则

1. **函数优先**：每个操作都是纯函数，无复杂类结构
2. **直接了当**：线性流程，无抽象层
3. **错误即停**：任何步骤出错立即抛出，不隐藏问题
4. **约定简单**：固定文件结构，减少配置项

### 模板变量设计（保持简单）

所有模板共享统一的数据结构：

```javascript
{
  site: {
    title: "网站标题",
    author: "作者名",
    description: "网站描述"
  },
  page: {
    title: "页面标题",
    content: "HTML内容",
    type: "index|page|chapter",  // 页面类型
    path: "文件路径"
  },
  nav: [
    {title: "首页", path: "/", type: "index"},
    {title: "关于", path: "/about.html", type: "page"},
    {title: "第一章", path: "/chapter1/", type: "chapter"}
  ]
}
```

## 命令行接口（直接>抽象）

```bash
# 构建静态网站
node bin/rbook.js build

# 启动开发服务器（可选）
node bin/rbook.js serve
```

> 无复杂参数解析，固定工作目录，简单直接

## 模板示例（保持简单）

### layout.njk - 基础布局
```html
<!DOCTYPE html>
<html>
<head>
    <title>{{ site.title }} - {{ page.title }}</title>
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
    {% include "partials/header.njk" %}
    {% include "partials/menu.njk" %}
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    {% include "partials/footer.njk" %}
</body>
</html>
```

### index.njk - 首页模板
```html
{% extends "layout.njk" %}

{% block content %}
<article class="home">
    <h1>{{ site.title }}</h1>
    <p>{{ site.description }}</p>
    {{ page.content | safe }}
</article>
{% endblock %}
```

### chapter.njk - 章节模板  
```html
{% extends "layout.njk" %}

{% block content %}
<article class="chapter">
    <h1>{{ page.title }}</h1>
    <div class="content">
        {{ page.content | safe }}
    </div>
    {% include "partials/toc.njk" %}
</article>
{% endblock %}
```

### menu.njk - 导航菜单
```html
<nav class="menu">
    <ul>
    {% for item in nav %}
        <li class="{{ item.type }}">
            <a href="{{ item.path }}">{{ item.title }}</a>
        </li>
    {% endfor %}
    </ul>
</nav>
```